define(function(require){var conf=require("conf");var frame=require("frame");var iconstyle=frame.getHeaderIconStyle();var ajax=require("ajax");var ThreadTab=require("./thread_tab");var o={};ForumDisplayPage=function(_fid){var h5page,fid,firstquery=true;if(_fid){fid=_fid}var threadtab;function init(){h5page=new MWT.H5Page({render:"page-forum-"+fid,header:frame.createHeader({items:[{icon:"icon icon-left",iconStyle:iconstyle,width:40,handler:function(){h5page.close()}},{label:'<h1 id="forumpagetitle-'+fid+'">论坛</h1>'},{icon:"icon icon-ask",iconStyle:iconstyle,width:40,handler:function(){require("./newthread").open("slideRight",fid,function(){query(1,1)})}}]}),bodyStyle:"background-color:#f2f2f2;padding:0;",pagebody:'<div id="forumlist-topdiv-'+fid+'"></div>'+'<div id="formtabdiv-'+fid+'" style="margin-top:.77em;"></div>'});h5page.on("open",function(){firstquery=true;threadtab=new ThreadTab("formtabdiv-"+fid,query);threadtab.init()})}function query(idx,page){var api="version=4&module=forumdisplay&fid="+fid+"&page="+page;switch(idx){case 2:api+="&filter=lastpost&orderby=lastpost";break;case 3:api+="&filter=digest&digest=1";break;case 4:api+="&filter=heat&orderby=heats";break}MWT.show_loading();ajax.post(api,{},function(res){MWT.hide_loading();if(firstquery){firstquery=false;renderSummary(res)}threadtab.show_list(res)})}function renderSummary(data){var fim=data.Variables.forum;jQuery("#forumpagetitle-"+fid).html(fim.name);var icon=fim.icon?fim.icon:conf.default_forum_icon;var code='<div name="fmdiv" data-fname="'+fim.name+'" class="weui_cell">'+'<div class="weui_cell_hd"><img src="'+icon+'" style="width:40px;height:40px;margin-right:10px;display:block"></div>'+'<div class="weui_cell_bd weui_cell_primary">'+""+fim.name+"<br>"+'<span style="font-size:13px;">主题:'+fim.threads+" | 帖子:"+fim.posts+"</span>"+"</div>"+'<div class="weui_cell_ft">'+'<span name="fav-forum-btn" data-fid="'+fid+'" '+'style="border-radius:300px;background:#f1f1f1;color:#DA5D0C;font-size:12px;padding:5px 10px;">'+'<i class="icon icon-favor"></i> 收藏</span>'+"</div>"+"</div>";if(data.Variables.sublist.length>0){var sublist=[];var title_max_width=dz.bodyWidth-120;for(var i=0;i<data.Variables.sublist.length;++i){var im=data.Variables.sublist[i];var cd='<div name="subforum" data-fid="'+im.fid+'" class="weui_cell">'+'<div class="weui_cell_bd weui_cell_primary">'+'<span class="text-block-nowrap" style="width:'+title_max_width+'px">'+im.name+"</span>"+"</div>"+'<div class="weui_cell_ft" style="font-size:13px;">'+'<span style="font-size:12px;">今日: '+im.todayposts+"</span>"+"</div>"+"</div>";sublist.push(cd)}code+='<div style="background:#fff;">'+'<div class="weui_cells_title mwt-border-bottom">子版块</div>'+'<div class="weui_cells">'+sublist.join("")+"</div>"+"</div>"}if(data.Variables.forum_threadlist.length>0){var top_threads=[];var title_max_width=dz.bodyWidth-80;for(var i=0;i<data.Variables.forum_threadlist.length;++i){var im=data.Variables.forum_threadlist[i];if(im.displayorder==0)continue;var cd='<div name="topthread" data-tid="'+im.tid+'" class="weui_cell">'+'<div class="weui_cell_bd weui_cell_primary">'+'<span class="text-block-nowrap" style="width:'+title_max_width+'px">'+im.subject+"</span>"+"</div>"+'<div class="weui_cell_ft" style="font-size:13px;">'+'<i class="icon icon-preview"></i> '+im.views+"</div>"+"</div>";top_threads.push(cd)}if(top_threads.length>0){code+='<div style="background:#fff;">'+'<div class="weui_cells_title mwt-border-bottom">置顶</div>'+'<div class="weui_cells">'+top_threads.join("")+"</div></div></div>"}}jQuery("#forumlist-topdiv-"+fid).html(code);if(data.Variables.sublist.length>0){jQuery("[name=subforum]").click(function(){var subfid=jQuery(this).data("fid");require("./forumdisplay").open(subfid,"slideRight")})}jQuery("[name=fav-forum-btn]").click(function(){var fid=jQuery(this).data("fid");var api="version=4&module=favforum&id="+fid+"&formhash="+ajax.getFormHash();ajax.post(api,{},function(res){if(res.Message&&res.Message.messageval=="favorite_do_success"){MWT.toast({msg:"已收藏"})}else if(res.Message.messageval=="favorite_repeat"){MWT.toast({msg:"已收藏"})}else{MWT.alert({msg:res.Message.messagestr})}})})}this.open=function(animate){init();h5page.setAnimate(animate).open()}};o.open=function(_fid,animate){var p=new ForumDisplayPage(_fid);p.open(animate)};return o});