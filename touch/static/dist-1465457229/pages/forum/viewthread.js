define(function(require){var conf=require("conf");var frame=require("frame");var iconstyle=frame.getHeaderIconStyle();var ajax=require("ajax");ThreadPage=function(tid){var h5page,firstquery=true,formhash;function init(){h5page=new MWT.H5Page({render:"page-thread-"+tid,header:frame.createHeader({items:[{icon:"icon icon-left",iconStyle:iconstyle,width:40,handler:function(){h5page.close()}},{label:'<h1 id="threadtitle'+tid+'">查看帖子</h1>'},{label:"",width:40}]}),footer:new MWT.H5Navbar({position:"bottom",cls:"footbar mwt-border-top",height:45,items:[{icon:"icon icon-comment",label:"回复",handler:function(){require("./sendreply").open("slideRight",tid,formhash,function(){query(1)})}},{icon:"icon icon-favor",label:"收藏",handler:function(){var api="version=4&module=favthread&id="+tid+"&formhash="+ajax.getFormHash();ajax.post(api,{},function(res){if(res.Message&&(res.Message.messageval=="favorite_do_success"||res.Message.messageval=="favorite_repeat")){MWT.toast({msg:"已收藏"})}else{MWT.alert({msg:res.Message.messagestr})}})}}]}),bodyStyle:"background-color:#f2f2f2;padding:0 0 45px 0;",pagebody:'<div id="vth-topdiv-'+tid+'" style="background:#fff;"></div>'+'<div style="background:#fff;">'+'<div class="weui_cells_title mwt-border-bottom">相关回复</div>'+'<div id="vthdiv-'+tid+'" style="min-height:50px;"></div>'+"</div>"});h5page.on("open",function(){firstquery=true;query(1)})}function query(page){var api="version=4&module=viewthread&tid="+tid+"&page="+page;MWT.show_loading();ajax.post(api,{},function(res){formhash=res.Variables.formhash;MWT.hide_loading();if(firstquery){firstquery=false;renderSummary(res)}show_list(res,page)})}function renderSummary(data){var tim=data.Variables.thread;var code='<div class="mwt-border-bottom">'+'<table class="tablay"><tr>'+'<td style="padding:2px 5px;">'+'<span style="font-size:18px;color:#333;">'+tim.subject+"</span><br>"+'<span style="float:right;display:block;color:#aaa;font-size:12px;padding-right:5px;">'+'<i class="icon icon-preview"></i> '+tim.views+"&nbsp;&nbsp;&nbsp;"+'<i class="icon icon-comment"></i> '+tim.replies+"</span>"+"</tr></table></div>";var post=data.Variables.postlist[0];var avatar=dz_avatar(post["authorid"]);var attachments=[];if(post.attachments){for(var i in post.attachments){var am=post.attachments[i];if(am.isimage=="1"){var img='<img src="'+am.url+am.attachment+'">';attachments.push(img)}}}code+="<div>"+'<div class="weui_cell" style="padding:5px;">'+'<div class="weui_cell_hd">'+'<img src="'+avatar+'" style="border-radius:300px;width:30px;height:30px;vertical-align:top;">'+"</div>"+'<div class="weui_cell_bd weui_cell_primary">'+'<span style="margin:0 8px;display:inline-block;font-size:12px;color:#333;">'+post.author+"<br>"+'<span style="float:left;font-size:11px;color:#999;">'+post.dateline+"</span></span>"+"</div>"+'<div class="weui_cell_ft" style="font-size:11px;color:#aaa">1楼</div>'+"</div>"+'<div style="padding:5px;word-break:break-all;" class="content-div">'+post.message+"<br>"+attachments.join("")+"</div>"+"</div>";jQuery("#vth-topdiv-"+tid).html(code)}function getcell(post){var avatar=dz_avatar(post["authorid"]);var code='<div class="mwt-border-bottom">'+'<div class="weui_cell" style="padding:5px;">'+'<div class="weui_cell_hd">'+'<img src="'+avatar+'" style="border-radius:300px;width:30px;height:30px;vertical-align:top;">'+"</div>"+'<div class="weui_cell_bd weui_cell_primary">'+'<span style="margin:0 8px;display:inline-block;font-size:12px;color:#333;">'+post.author+"<br>"+'<span style="float:left;font-size:11px;color:#999;">'+post.dateline+"</span></span>"+"</div>"+'<div class="weui_cell_ft" style="font-size:11px;color:#aaa">'+post.number+"楼</div>"+"</div>"+'<div style="padding:5px;" class="content-div">'+post.message+"</div>"+"</div>";return code}function show_list(data,page){var list=[];var currentPageSize=data.Variables.postlist.length;for(var i=0;i<currentPageSize;++i){var post=data.Variables.postlist[i];if(post.number==1)continue;list.push(getcell(post))}var basediv="vthdiv-"+tid;var rd=page==1?basediv:basediv+"-"+page;var code=list.join("");if(has_next_page(page,data.Variables.thread.replies,data.Variables.ppp,currentPageSize)){var nextpage=page+1;code+='<div id="'+basediv+"-"+nextpage+'">'+'<button id="'+basediv+'-nbtn" data-page="'+nextpage+'" class="nextbtn">点击加载下一页</button>'+"</div>"}jQuery("#"+rd).html(code);jQuery("#"+basediv+"-nbtn").unbind("click").click(function(){var pg=jQuery(this).data("page");query(pg)})}this.open=function(animate){init();h5page.setAnimate(animate).open()}};var o={};o.open=function(tid,animate){var p=new ThreadPage(tid);p.open(animate)};return o});