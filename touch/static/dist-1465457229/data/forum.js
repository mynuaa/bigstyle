define(function(require){var ajax=require("ajax");var conf=require("conf");var o={};var forumMap;var forumSelectOptions;var forumThreadTypesMap;function load_forum_map(){ajax.loadcache("version=4&module=forumindex",function(res){forumMap={};for(var i=0;i<res.Variables.forumlist.length;++i){var fm=res.Variables.forumlist[i];forumMap[fm.fid]={fid:fm.fid,name:fm.name,threads:fm.threads,posts:fm.posts,todayposts:fm.todayposts,icon:fm.icon?fm.icon:conf.default_forum_icon};if(fm.sublist&&fm.sublist.length>0){forumMap[fm.fid]["sublist"]=[];for(var k=0;k<fm.sublist.length;++k){var fsm=fm.sublist[k];forumMap[fm.fid]["sublist"].push(fsm.fid);forumMap[fsm.fid]={fid:fsm.fid,name:fsm.name,threads:fsm.threads,posts:fsm.posts,todayposts:fsm.todayposts,icon:fsm.icon?fsm.icon:conf.default_forum_icon}}}}create_forum_select_options(res)},true)}function create_forum_select_options(res){forumSelectOptions='<option value="0">请选择版块</option>';if(!res||!res.Variables.catlist)return;for(var i=0;i<res.Variables.catlist.length;++i){var catitem=res.Variables.catlist[i];if(!catitem.forums||!catitem.forums.length)continue;forumSelectOptions+='<optgroup label="'+catitem.name+'">';for(var m=0;m<catitem.forums.length;++m){var forumid=catitem.forums[m];var foruminfo=forumMap[forumid];if(foruminfo){forumSelectOptions+='<option value="'+foruminfo.fid+'">'+foruminfo.name+"</option>";if(foruminfo.sublist&&foruminfo.sublist.length>0){for(var n=0;n<foruminfo.sublist.length;++n){var sfid=foruminfo.sublist[n];var sfinfo=forumMap[sfid];if(sfinfo){forumSelectOptions+='<option value="'+sfinfo.fid+'">&nbsp;&nbsp;&nbsp;&nbsp;'+sfinfo.name+"</option>"}}}}}}}function load_forum_thread_types(){ajax.loadcache("version=4&module=forumnav",function(res){forumThreadTypesMap={};if(!res.Variables.forums)return;for(var i=0;i<res.Variables.forums.length;++i){var fm=res.Variables.forums[i];forumThreadTypesMap[fm.fid]=[];if(fm.threadtypes&&fm.threadtypes.types){for(var tid in fm.threadtypes.types){var typeitem={tid:tid,name:fm.threadtypes.types[tid]};forumThreadTypesMap[fm.fid].push(typeitem)}}}},true)}o.getForumInfo=function(fid){if(!forumMap){load_forum_map()}return forumMap[fid]};o.getHotForums=function(){var list=[];var api="version=4&module=hotforum";ajax.loadcache(api,function(res){if(!res.Variables.data||!res.Variables.data.length)return;for(var i=0;i<res.Variables.data.length;++i){var im=res.Variables.data[i];var fid=im.fid;var finfo=o.getForumInfo(im.fid);if(finfo&&finfo.icon){im.icon=finfo.icon;list.push(im)}}},true);if(list.length==0){for(var fid in forumMap){list.push(forumMap[fid]);if(list.length>2)break}}return list};o.getAllForumIds=function(){var list=[];if(!forumMap)load_forum_map();for(var fid in forumMap)list.push(fid);return list};o.getForumSelectOptions=function(){if(!forumSelectOptions)load_forum_map();return forumSelectOptions};o.getForumThreadTypes=function(fid){if(!forumThreadTypesMap)load_forum_thread_types();if(forumThreadTypesMap[fid])return forumThreadTypesMap[fid];return[]};o.getForumMap=function(){if(!forumMap)load_forum_map();return forumMap};return o});